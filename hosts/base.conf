# =============================================================================
# Caddy Snippets
# =============================================================================
#
# Shared configurations for all sites. Import with: import <name>
#
# Auto-enabled by watcher (disable with CADDY_*=false):
#   tls, compression, header, performance, security
#
# Opt-in (enable with CADDY_*=true):
#   logging, auth, seo, wordpress
#
# =============================================================================

{
    order replace after encode
    email {env.EMAIL}
}

# -----------------------------------------------------------------------------
# IP Matchers
# -----------------------------------------------------------------------------

# (cloudflare) - Matcher for Cloudflare proxy IPs
# Source: https://www.cloudflare.com/ips-v4/
(cloudflare) {
    @cloudflare {
        remote_ip 173.245.48.0/20 103.21.244.0/22 103.22.200.0/22 103.31.4.0/22 141.101.64.0/18 108.162.192.0/18 190.93.240.0/20 188.114.96.0/20 197.234.240.0/22 198.41.128.0/17 162.158.0.0/15 104.16.0.0/13 104.24.0.0/14 172.64.0.0/13 131.0.72.0/22
    }
}

# (internal) - Matcher for private IP ranges (10.x, 172.16-31.x, 192.168.x)
(internal) {
    @internal {
        remote_ip private_ranges
    }
}

# -----------------------------------------------------------------------------
# Core Features (auto-enabled)
# -----------------------------------------------------------------------------

# (tls) - Cloudflare DNS challenge for wildcard/internal domains
# Disable with CADDY_TLS=false to use HTTP challenge instead (TLS stays enabled)
(tls) {
    tls {
        dns cloudflare {env.CF_API_TOKEN}
    }
}

# (compression) - zstd and gzip compression
(compression) {
    encode zstd gzip
}

# (header) - Security headers (HSTS, anti-clickjacking, no indexing)
(header) {
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options nosniff
        X-Frame-Options "SAMEORIGIN"
        Referrer-Policy "strict-origin-when-cross-origin"
        X-Robots-Tag "none"
        -Server
        -X-Powered-By
    }
}

# (performance) - Static asset caching, skip noisy logs
# Uses ?Header to set only if upstream doesn't already set it (fallback)
(performance) {
    @meta path /favicon.ico /robots.txt
    log_skip @meta

    @static path *.css *.css.map *.js *.js.map *.jpg *.jpeg *.png *.gif *.ico *.cur *.heic *.webp *.tif *.tiff *.mp3 *.m4a *.aac *.ogg *.midi *.mid *.wav *.mp4 *.mov *.webm *.mpeg *.mpg *.avi *.ogv *.flv *.wmv *.htc *.gz *.svg *.svgz *.woff2 *.woff
    header @static ?Cache-Control "public, immutable, stale-while-revalidate, max-age=31536000"

    @fonts path *.svg *.svgz *.ttf *.ttc *.otf *.eot *.woff *.woff2
    header @fonts ?Access-Control-Allow-Origin "*"

    @dynamic path *.json *.xml *.rss
    header @dynamic ?Cache-Control "no-cache, max-age=3600"
}

# (security) - Block access to sensitive files (.env, .git, backups, etc.)
(security) {
    @sensitive path *.bak *.conf *.dist *.env *.fla *.ini *.inc *.inci *.log *.orig *.psd *.sh *.sql *.swo *.swp *.swop */.*
    respond @sensitive 403

    @devfiles path /composer.json /composer.lock /package.json /package-lock.json /yarn.lock /.git/*
    respond @devfiles 403
}

# -----------------------------------------------------------------------------
# Opt-in Features
# -----------------------------------------------------------------------------

# (logging) - Request logging to stdout
(logging) {
    log
}

# (seo) - Allow search engine indexing (removes X-Robots-Tag from header snippet)
(seo) {
    header {
        -X-Robots-Tag
    }
}

# (auth) - Forward authentication via tinyauth (requires docker-compose.auth.yml)
# Use CADDY_AUTH_PATHS to protect only specific paths instead of entire site
(auth) {
    forward_auth {env.COMPOSE_PROJECT_NAME}-tinyauth-1:3000 {
        uri /api/auth/caddy
        copy_headers Remote-User Remote-Email Remote-Groups
    }
}

# (wordpress) - WordPress security: block PHP execution in unsafe directories
(wordpress) {
    @wp-uploads path /wp-content/uploads/**.php
    @wp-plugins path /wp-content/plugins/**.php
    @wp-themes path /wp-content/themes/**.php
    respond @wp-uploads 403
    respond @wp-plugins 403
    respond @wp-themes 403

    @wp-sensitive path /wp-admin/install.php /wp-admin/includes/*.php /wp-includes/*/*.php /wp-includes/js/tinymce/langs/*.php /wp-includes/theme-compat/*.php /wp-config.php /wp-config-sample.php /readme.html /license.txt
    respond @wp-sensitive 403
}
