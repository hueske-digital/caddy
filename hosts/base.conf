# =============================================================================
# Caddy Snippets
# =============================================================================
#
# Shared configurations for all sites. Import with: import <name>
#
# Auto-enabled by watcher (disable with CADDY_*=false):
#   tls, compression, header, performance, security
#
# Opt-in (enable with CADDY_*=true):
#   logging, auth, seo, wordpress
#
# =============================================================================

{
    log {
        level {$LOG_LEVEL:ERROR}
    }
    order replace after encode
    email {env.EMAIL}
}

# -----------------------------------------------------------------------------
# IP Matchers
# -----------------------------------------------------------------------------

# (cloudflare) - Matcher for Cloudflare proxy IPs
# Source: https://www.cloudflare.com/ips-v4/
(cloudflare) {
    @cloudflare {
        remote_ip 173.245.48.0/20 103.21.244.0/22 103.22.200.0/22 103.31.4.0/22 141.101.64.0/18 108.162.192.0/18 190.93.240.0/20 188.114.96.0/20 197.234.240.0/22 198.41.128.0/17 162.158.0.0/15 104.16.0.0/13 104.24.0.0/14 172.64.0.0/13 131.0.72.0/22
    }
}

# (internal) - Matcher for private IP ranges (10.x, 172.16-31.x, 192.168.x)
(internal) {
    @internal {
        remote_ip private_ranges
    }
}

# -----------------------------------------------------------------------------
# Core Features (auto-enabled)
# -----------------------------------------------------------------------------

# (tls-cloudflare) - Cloudflare DNS challenge
(tls-cloudflare) {
    tls {
        dns cloudflare {env.CF_API_TOKEN}
    }
}

# (tls-hetzner) - Hetzner DNS challenge
# propagation_delay fixes slow DNS propagation
(tls-hetzner) {
    tls {
        dns hetzner {env.HETZNER_API_TOKEN}
        propagation_delay 30s
    }
}

# (tls) - Alias for backwards compatibility
(tls) {
    import tls-cloudflare
}

# (compression) - zstd and gzip compression
(compression) {
    encode zstd gzip
}

# (header) - Security headers (HSTS, anti-clickjacking)
(header) {
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options nosniff
        X-Frame-Options "SAMEORIGIN"
        Referrer-Policy "strict-origin-when-cross-origin"
        -Server
        -X-Powered-By
    }
}

# (noindex) - Block search engine indexing
(noindex) {
    header X-Robots-Tag "none"
}

# (performance) - Static asset caching, skip noisy logs
# Uses ?Header to set only if upstream doesn't already set it (fallback)
(performance) {
    @meta path /favicon.ico /robots.txt
    log_skip @meta

    @static path *.css *.css.map *.js *.js.map *.jpg *.jpeg *.png *.gif *.ico *.cur *.heic *.webp *.tif *.tiff *.mp3 *.m4a *.aac *.ogg *.midi *.mid *.wav *.mp4 *.mov *.webm *.mpeg *.mpg *.avi *.ogv *.flv *.wmv *.htc *.gz *.svg *.svgz *.woff2 *.woff
    header @static ?Cache-Control "public, immutable, stale-while-revalidate, max-age=31536000"

    @fonts path *.svg *.svgz *.ttf *.ttc *.otf *.eot *.woff *.woff2
    header @fonts ?Access-Control-Allow-Origin "*"

    @dynamic path *.json *.xml *.rss
    header @dynamic ?Cache-Control "no-cache, max-age=3600"
}

# (security) - Block access to sensitive files (.env, .git, backups, etc.)
(security) {
    @sensitive {
        path *.bak *.conf *.dist *.env *.fla *.ini *.inc *.inci *.log *.orig *.psd *.sh *.sql *.swo *.swp *.swop */.*
        not path /.well-known/*
    }
    respond @sensitive 403

    @devfiles path /composer.json /composer.lock /package.json /package-lock.json /yarn.lock /.git/* /README.md /CHANGELOG.md /LICENSE.md /CONTRIBUTING.md
    respond @devfiles 403
}

# -----------------------------------------------------------------------------
# Opt-in Features
# -----------------------------------------------------------------------------

# (logging) - Request logging to stdout
(logging) {
    log
}


# (auth) - Forward authentication via tinyauth (requires docker-compose.auth.yml)
# Use CADDY_AUTH_PATHS to protect only specific paths instead of entire site
(auth) {
    forward_auth {env.COMPOSE_PROJECT_NAME}-tinyauth-1:3000 {
        uri /api/auth/caddy
        copy_headers Remote-User Remote-Email Remote-Groups
    }
}

# (wordpress) - WordPress security: block PHP execution in unsafe directories
(wordpress) {
    @wp-uploads path /wp-content/uploads/**.php
    @wp-plugins path /wp-content/plugins/**.php
    @wp-themes path /wp-content/themes/**.php
    respond @wp-uploads 403
    respond @wp-plugins 403
    respond @wp-themes 403

    @wp-sensitive path /wp-admin/install.php /wp-admin/includes/*.php /wp-includes/*/*.php /wp-includes/js/tinymce/langs/*.php /wp-includes/theme-compat/*.php /wp-config.php /wp-config-sample.php /readme.html /license.txt
    respond @wp-sensitive 403
}

# (stealth) - Stealth 404 page with shuffle effect (use instead of abort)
(stealth) {
    header Content-Type "text/html; charset=utf-8"
    respond `<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="robots" content="noindex,nofollow"><title>404</title><style>*{margin:0;padding:0;box-sizing:border-box}:root{--bg:#fafafa;--text:#0d0d0d}@media(prefers-color-scheme:dark){:root{--bg:#0d0d0d;--text:#ededed}}html,body{height:100%;background:var(--bg);color:var(--text);font-family:Inter,system-ui,sans-serif}body{display:flex;justify-content:center;align-items:center}.c{display:flex;flex-direction:column;align-items:center;gap:1.5rem}.n{font-size:clamp(7rem,28vw,16rem);font-weight:700;letter-spacing:-.06em;line-height:1;font-variant-numeric:tabular-nums}.n .t{display:inline-block;min-width:3ch;text-align:center}.s{font-size:clamp(.875rem,2vw,1.125rem);font-weight:400;letter-spacing:.2em;text-transform:uppercase;opacity:.4}.s .t{display:inline-block;min-width:9ch;text-align:center}.h{display:none}@media(max-width:480px){.n{writing-mode:vertical-rl;text-orientation:upright;letter-spacing:0;font-size:clamp(5rem,20vw,8rem)}.n .t{min-width:auto}}</style></head><body><div class="c"><div class="n"><span class="h">404</span><span class="t"></span></div><div class="s"><span class="h">not found</span><span class="t"></span></div></div><script>const S=(e,c,s,d)=>{const h=e.querySelector(".h"),t=e.querySelector(".t"),x=h.textContent;let f=0,r=0;const l=()=>{let o="";for(let i=0;i<x.length;i++)o+=x[i]===" "?" ":i<r?x[i]:c[Math.floor(Math.random()*c.length)];t.textContent=o;f++;if(f%s===0&&r<x.length)r++;r<x.length?requestAnimationFrame(l):t.textContent=x};setTimeout(l,d)};S(document.querySelector(".n"),"0123456789",12,150);S(document.querySelector(".s"),"ABCDEFGHIJKLMNOPQRSTUVWXYZ",6,600)</script></body></html>` 404
}
